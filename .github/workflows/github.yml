# GitHub Actions 发布到 GitHub Packages
name: Publish to GitHub Packages

on:
  workflow_dispatch:

permissions:
  contents: write # 如果需要更新代码
  packages: write # 必须的权限来发布包
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3. 安装 pnpm
      - name: Install pnpm
        run: |
          npm install -g pnpm@8
          pnpm --version

      # 4. 安装依赖
      - name: Install dependencies
        run: pnpm install

      # 5. 设置 .npmrc 配置（GitHub Packages）
      - name: Setup .npmrc for GitHub Packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > ~/.npmrc
          echo "@dr-forget:registry=https://npm.pkg.github.com/" >> ~/.npmrc

      # 7. 发布到 GitHub Packages
      - name: Publish core package to GitHub Packages
        run: |
          cd packages/core
          pnpm publish --access restricted --registry=https://npm.pkg.github.com/ --no-git-checks  # 发布到 GPR
